#:kivy 2.0

# ═══════════════════════════════════════════════════════════════════════════
# Root widget: vertical BoxLayout with ScreenManager + bottom nav bar
# ═══════════════════════════════════════════════════════════════════════════
<GCSRoot>:
    orientation: 'vertical'
    canvas.before:
        Color:
            rgba: 0.12, 0.12, 0.14, 1
        Rectangle:
            pos: self.pos
            size: self.size

    # ── Screen area ──
    ScreenManager:
        id: sm

    # ── Bottom navigation bar ──
    BoxLayout:
        size_hint_y: None
        height: dp(48)
        canvas.before:
            Color:
                rgba: 0.15, 0.15, 0.18, 1
            Rectangle:
                pos: self.pos
                size: self.size

        NavButton:
            text: 'Connect'
            on_release: app.switch_screen('connection')
        NavButton:
            text: 'Telemetry'
            on_release: app.switch_screen('telemetry')
        NavButton:
            text: 'Command'
            on_release: app.switch_screen('command')
        NavButton:
            text: 'HUD'
            on_release: app.switch_screen('hud')
        NavButton:
            text: 'Sensors'
            on_release: app.switch_screen('sensor_plots')
        NavButton:
            text: 'Profiles'
            on_release: app.switch_screen('profile')
        NavButton:
            text: 'Map'
            on_release: app.switch_screen('map')
        NavButton:
            text: 'Monitor'
            on_release: app.switch_screen('monitoring')
        NavButton:
            text: 'Settings'
            on_release: app.switch_screen('settings')


# ═══════════════════════════════════════════════════════════════════════════
# Reusable nav button
# ═══════════════════════════════════════════════════════════════════════════
<NavButton@Button>:
    font_size: sp(12)
    size_hint_x: 1
    background_color: 0.2, 0.2, 0.25, 1
    color: 0.8, 0.85, 0.9, 1


# ═══════════════════════════════════════════════════════════════════════════
# Reusable telemetry tile and section label
# ═══════════════════════════════════════════════════════════════════════════
<TelemetryTile>:
    orientation: 'vertical'
    padding: dp(4)
    canvas.before:
        Color:
            rgba: self.tile_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(5)]
    Label:
        text: root.label_text
        font_size: sp(10)
        size_hint_y: 0.35
        color: 0.55, 0.6, 0.65, 1
        halign: 'center'
        text_size: self.size
        valign: 'middle'
    Label:
        text: root.value_text
        font_size: sp(18)
        bold: True
        size_hint_y: 0.65
        color: 1, 1, 1, 1
        halign: 'center'
        text_size: self.size
        valign: 'middle'

<SectionLabel@Label>:
    font_size: sp(10)
    size_hint_y: None
    height: dp(16)
    color: 0.45, 0.48, 0.52, 1
    halign: 'left'
    text_size: self.size
    valign: 'middle'
    bold: True


# ═══════════════════════════════════════════════════════════════════════════
# Connection Screen
# ═══════════════════════════════════════════════════════════════════════════
<ConnectionScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(12)

        # ── Title ──
        Label:
            text: 'CopterSonde GCS'
            font_size: sp(22)
            bold: True
            size_hint_y: None
            height: dp(36)
            color: 0.8, 0.85, 0.9, 1

        # ── Status indicator ──
        Label:
            id: status_label
            text: 'Not Connected'
            font_size: sp(40)
            bold: True
            size_hint_y: 0.3
            color: 0.7, 0.2, 0.2, 1

        # ── Detail info ──
        Label:
            id: detail_label
            text: 'Configure connection below'
            font_size: sp(14)
            size_hint_y: None
            height: dp(48)
            color: 0.6, 0.6, 0.6, 1
            text_size: self.size
            halign: 'center'
            valign: 'top'

        # ── Transport config ──
        BoxLayout:
            size_hint_y: None
            height: dp(44)
            spacing: dp(10)
            padding: [dp(40), 0, dp(40), 0]

            Label:
                text: 'IP:'
                size_hint_x: None
                width: dp(30)
                font_size: sp(14)
                color: 0.7, 0.7, 0.7, 1
            TextInput:
                id: ip_input
                text: '0.0.0.0'
                font_size: sp(14)
                multiline: False
                size_hint_x: 0.55
                input_filter: None
                background_color: 0.2, 0.2, 0.25, 1
                foreground_color: 1, 1, 1, 1
                cursor_color: 1, 1, 1, 1

            Label:
                text: 'Port:'
                size_hint_x: None
                width: dp(40)
                font_size: sp(14)
                color: 0.7, 0.7, 0.7, 1
            TextInput:
                id: port_input
                text: '14550'
                font_size: sp(14)
                multiline: False
                size_hint_x: 0.25
                input_filter: 'int'
                background_color: 0.2, 0.2, 0.25, 1
                foreground_color: 1, 1, 1, 1
                cursor_color: 1, 1, 1, 1

        # ── Connect button ──
        BoxLayout:
            size_hint_y: None
            height: dp(52)
            padding: [dp(60), 0, dp(60), 0]
            spacing: dp(20)

            Button:
                id: connect_btn
                text: 'Connect'
                font_size: sp(18)
                background_color: 0.2, 0.55, 0.3, 1
                on_release: root.on_connect_toggle()

        # ── Demo mode toggle ──
        BoxLayout:
            size_hint_y: None
            height: dp(44)
            padding: [dp(60), 0, dp(60), 0]
            spacing: dp(10)

            Label:
                text: 'Demo Mode (simulated telemetry)'
                font_size: sp(14)
                color: 0.7, 0.7, 0.7, 1
                halign: 'right'
                text_size: self.size
                valign: 'middle'

            Switch:
                id: demo_toggle
                size_hint_x: None
                width: dp(80)
                active: False
                on_active: root.on_demo_toggle(self.active)

        Widget:
            size_hint_y: 0.1


# ═══════════════════════════════════════════════════════════════════════════
# Placeholder screens
# ═══════════════════════════════════════════════════════════════════════════
<TelemetryScreen>:
    ScrollView:
        do_scroll_y: True
        do_scroll_x: False
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            padding: dp(10)
            spacing: dp(4)

            # ── Title bar ──
            BoxLayout:
                size_hint_y: None
                height: dp(28)
                Label:
                    text: 'Telemetry'
                    font_size: sp(20)
                    bold: True
                    color: 0.8, 0.85, 0.9, 1
                    halign: 'left'
                    text_size: self.size
                    valign: 'middle'
                Label:
                    id: last_update_label
                    text: ''
                    font_size: sp(11)
                    color: 0.5, 0.5, 0.5, 1
                    halign: 'right'
                    text_size: self.size
                    valign: 'middle'

            # ── System ──
            SectionLabel:
                text: 'SYSTEM'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_mode
                    label_text: 'FLIGHT MODE'
                TelemetryTile:
                    id: tile_armed
                    label_text: 'ARMED'
                TelemetryTile:
                    id: tile_time
                    label_text: 'TIME IN AIR'

            # ── Battery ──
            SectionLabel:
                text: 'BATTERY'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_batt_pct
                    label_text: 'BATTERY %'
                TelemetryTile:
                    id: tile_voltage
                    label_text: 'VOLTAGE'
                TelemetryTile:
                    id: tile_current
                    label_text: 'CURRENT'

            # ── Navigation ──
            SectionLabel:
                text: 'NAVIGATION'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_alt_rel
                    label_text: 'ALT REL'
                TelemetryTile:
                    id: tile_alt_amsl
                    label_text: 'ALT AMSL'
                TelemetryTile:
                    id: tile_heading
                    label_text: 'HEADING'

            # ── Speed ──
            SectionLabel:
                text: 'SPEED'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_gndspd
                    label_text: 'GND SPEED'
                TelemetryTile:
                    id: tile_airspd
                    label_text: 'AIR SPEED'
                TelemetryTile:
                    id: tile_vertspd
                    label_text: 'VERT SPEED'

            # ── GPS ──
            SectionLabel:
                text: 'GPS'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_gps_fix
                    label_text: 'FIX TYPE'
                TelemetryTile:
                    id: tile_sats
                    label_text: 'SATELLITES'
                TelemetryTile:
                    id: tile_hdop
                    label_text: 'HDOP'

            # ── Radio / Throttle ──
            SectionLabel:
                text: 'RADIO / THROTTLE'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_rssi
                    label_text: 'RSSI'
                TelemetryTile:
                    id: tile_throttle
                    label_text: 'THROTTLE'
                Widget:

            # ── Copy snapshot ──
            BoxLayout:
                size_hint_y: None
                height: dp(38)
                padding: [dp(80), dp(2), dp(80), dp(2)]
                Button:
                    text: 'Copy Snapshot'
                    font_size: sp(13)
                    background_color: 0.25, 0.35, 0.5, 1
                    color: 0.85, 0.9, 0.95, 1
                    on_release: root.copy_snapshot()

<CommandScreen>:
    ScrollView:
        do_scroll_y: True
        do_scroll_x: False
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            padding: dp(10)
            spacing: dp(6)

            # ── Title ──
            Label:
                text: 'Control & Command'
                font_size: sp(20)
                bold: True
                size_hint_y: None
                height: dp(28)
                color: 0.8, 0.85, 0.9, 1

            # ── Armed status indicator ──
            Label:
                id: armed_indicator
                text: 'DISARMED'
                font_size: sp(30)
                bold: True
                size_hint_y: None
                height: dp(40)
                color: 0.3, 0.8, 0.4, 1

            Label:
                id: mode_display
                text: 'Mode: ---'
                font_size: sp(15)
                size_hint_y: None
                height: dp(22)
                color: 0.6, 0.65, 0.7, 1

            # ── Arm / Disarm ──
            SectionLabel:
                text: 'ARM / DISARM'
            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(10)
                padding: [dp(40), 0, dp(40), 0]
                Button:
                    text: 'ARM'
                    font_size: sp(16)
                    bold: True
                    background_color: 0.7, 0.3, 0.15, 1
                    on_release: root.on_arm()
                Button:
                    text: 'DISARM'
                    font_size: sp(16)
                    bold: True
                    background_color: 0.2, 0.45, 0.25, 1
                    on_release: root.on_disarm()

            # ── Flight Mode ──
            SectionLabel:
                text: 'FLIGHT MODE'
            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(10)
                padding: [dp(40), 0, dp(40), 0]
                Spinner:
                    id: mode_spinner
                    text: 'STABILIZE'
                    values: ['STABILIZE', 'ALT_HOLD', 'LOITER', 'GUIDED', 'AUTO', 'RTL', 'LAND', 'CIRCLE', 'POSHOLD', 'BRAKE']
                    font_size: sp(14)
                    size_hint_x: 0.6
                    background_color: 0.25, 0.25, 0.3, 1
                    color: 1, 1, 1, 1
                Button:
                    text: 'SET MODE'
                    font_size: sp(14)
                    size_hint_x: 0.4
                    background_color: 0.25, 0.35, 0.5, 1
                    on_release: root.on_set_mode()

            # ── Flight Commands ──
            SectionLabel:
                text: 'FLIGHT COMMANDS'
            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(10)
                padding: [dp(40), 0, dp(40), 0]
                Label:
                    text: 'Alt (m):'
                    font_size: sp(14)
                    size_hint_x: None
                    width: dp(55)
                    color: 0.7, 0.7, 0.7, 1
                TextInput:
                    id: takeoff_alt
                    text: '10'
                    font_size: sp(14)
                    multiline: False
                    size_hint_x: 0.25
                    input_filter: 'float'
                    background_color: 0.2, 0.2, 0.25, 1
                    foreground_color: 1, 1, 1, 1
                    cursor_color: 1, 1, 1, 1
                Button:
                    text: 'TAKEOFF'
                    font_size: sp(14)
                    size_hint_x: 0.35
                    background_color: 0.55, 0.4, 0.1, 1
                    on_release: root.on_takeoff()

            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(10)
                padding: [dp(40), 0, dp(40), 0]
                Button:
                    text: 'LAND'
                    font_size: sp(16)
                    background_color: 0.25, 0.35, 0.5, 1
                    on_release: root.on_land()
                Button:
                    text: 'RTL'
                    font_size: sp(16)
                    background_color: 0.55, 0.35, 0.1, 1
                    on_release: root.on_rtl()

            # ── Set Parameter ──
            SectionLabel:
                text: 'SET PARAMETER'
            BoxLayout:
                size_hint_y: None
                height: dp(44)
                spacing: dp(8)
                padding: [dp(40), 0, dp(40), 0]
                Label:
                    text: 'Name:'
                    font_size: sp(13)
                    size_hint_x: None
                    width: dp(45)
                    color: 0.7, 0.7, 0.7, 1
                TextInput:
                    id: param_name
                    hint_text: 'PARAM_NAME'
                    font_size: sp(13)
                    multiline: False
                    size_hint_x: 0.4
                    background_color: 0.2, 0.2, 0.25, 1
                    foreground_color: 1, 1, 1, 1
                    cursor_color: 1, 1, 1, 1
                Label:
                    text: 'Val:'
                    font_size: sp(13)
                    size_hint_x: None
                    width: dp(30)
                    color: 0.7, 0.7, 0.7, 1
                TextInput:
                    id: param_value
                    hint_text: '0.0'
                    font_size: sp(13)
                    multiline: False
                    size_hint_x: 0.2
                    input_filter: 'float'
                    background_color: 0.2, 0.2, 0.25, 1
                    foreground_color: 1, 1, 1, 1
                    cursor_color: 1, 1, 1, 1
                Button:
                    text: 'SET'
                    font_size: sp(13)
                    size_hint_x: 0.15
                    background_color: 0.25, 0.35, 0.5, 1
                    on_release: root.on_set_param()

            # ── Feedback ──
            Label:
                id: cmd_feedback
                text: ''
                font_size: sp(13)
                size_hint_y: None
                height: dp(28)
                color: 0.5, 0.6, 0.7, 1
                halign: 'center'
                text_size: self.size
                valign: 'middle'

            Widget:
                size_hint_y: None
                height: dp(10)

<HUDScreen>:
    FlightHUD:
        id: hud

<SensorPlotScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(6)
        spacing: dp(4)

        # Temperature plot
        TimeSeriesPlot:
            id: temp_plot
            title: 'Temperature (\u00b0C)'
            y_label: '\u00b0C'
            x_window: 120

        # Humidity plot
        TimeSeriesPlot:
            id: rh_plot
            title: 'Relative Humidity (%)'
            y_label: '%'
            x_window: 120

        # Controls bar
        BoxLayout:
            size_hint_y: None
            height: dp(36)
            spacing: dp(8)
            padding: [dp(20), 0, dp(20), 0]

            Button:
                id: pause_btn
                text: 'Pause'
                font_size: sp(13)
                size_hint_x: 0.3
                background_color: 0.25, 0.35, 0.5, 1
                on_release: root.toggle_pause()

            Button:
                text: 'Export CSV'
                font_size: sp(13)
                size_hint_x: 0.3
                background_color: 0.25, 0.35, 0.5, 1
                on_release: root.export_csv()

            Label:
                id: export_feedback
                text: ''
                font_size: sp(11)
                size_hint_x: 0.4
                color: 0.5, 0.6, 0.5, 1
                halign: 'left'
                text_size: self.size
                valign: 'middle'

<ProfileScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: 'Temperature & Wind Profiles'
            font_size: sp(24)
            bold: True
            color: 0.8, 0.85, 0.9, 1
        Label:
            text: 'Coming soon'
            font_size: sp(16)
            color: 0.5, 0.5, 0.5, 1

<MapScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: 'Satellite Map'
            font_size: sp(24)
            bold: True
            color: 0.8, 0.85, 0.9, 1
        Label:
            text: 'Coming soon'
            font_size: sp(16)
            color: 0.5, 0.5, 0.5, 1

<MonitoringScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: 'Tracking & Monitoring'
            font_size: sp(24)
            bold: True
            color: 0.8, 0.85, 0.9, 1
        Label:
            text: 'Coming soon'
            font_size: sp(16)
            color: 0.5, 0.5, 0.5, 1

<SettingsScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: 'Settings'
            font_size: sp(24)
            bold: True
            color: 0.8, 0.85, 0.9, 1
        Label:
            text: 'Coming soon'
            font_size: sp(16)
            color: 0.5, 0.5, 0.5, 1
