#:kivy 2.0

# ═══════════════════════════════════════════════════════════════════════════
# Root widget: vertical BoxLayout with ScreenManager + bottom nav bar
# ═══════════════════════════════════════════════════════════════════════════
<GCSRoot>:
    orientation: 'vertical'
    canvas.before:
        Color:
            rgba: app.theme_bg_root
        Rectangle:
            pos: self.pos
            size: self.size

    # ── Screen area ──
    ScreenManager:
        id: sm

    # ── Bottom navigation bar ──
    BoxLayout:
        size_hint_y: None
        height: dp(48)
        canvas.before:
            Color:
                rgba: app.theme_bg_navbar
            Rectangle:
                pos: self.pos
                size: self.size

        NavButton:
            text: 'Connect'
            on_release: app.switch_screen('connection')
        NavButton:
            text: 'Flight'
            on_release: app.switch_screen('flight')
        NavButton:
            text: 'Map'
            on_release: app.switch_screen('map')
        NavButton:
            text: 'Sensors'
            on_release: app.switch_screen('sensor_plots')
        NavButton:
            text: 'Profiles'
            on_release: app.switch_screen('profile')
        NavButton:
            text: 'Settings'
            on_release: app.switch_screen('settings')


# ═══════════════════════════════════════════════════════════════════════════
# Reusable nav button
# ═══════════════════════════════════════════════════════════════════════════
<NavButton@Button>:
    font_size: sp(12)
    size_hint_x: 1
    background_color: app.theme_bg_input
    color: app.theme_text_title


# ═══════════════════════════════════════════════════════════════════════════
# Reusable telemetry tile and section label
# ═══════════════════════════════════════════════════════════════════════════
<TelemetryTile>:
    orientation: 'vertical'
    padding: dp(4)
    canvas.before:
        Color:
            rgba: self.tile_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(5)]
    Label:
        text: root.label_text
        font_size: sp(9)
        size_hint_y: 0.35
        color: app.theme_text_tile_label
        halign: 'center'
        text_size: self.size
        valign: 'middle'
    Label:
        text: root.value_text
        font_size: sp(15)
        bold: True
        size_hint_y: 0.65
        color: app.theme_text_primary
        halign: 'center'
        text_size: self.size
        valign: 'middle'

<SectionLabel@Label>:
    font_size: sp(10)
    size_hint_y: None
    height: dp(16)
    color: app.theme_text_section
    halign: 'center'
    text_size: self.size
    valign: 'middle'
    bold: True


# ═══════════════════════════════════════════════════════════════════════════
# Connection Screen
# ═══════════════════════════════════════════════════════════════════════════
<ConnectionScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(12)

        # ── Title ──
        Label:
            text: 'CopterSonde GCS'
            font_size: sp(22)
            bold: True
            size_hint_y: None
            height: dp(36)
            color: app.theme_text_title

        # ── Status indicator ──
        Label:
            id: status_label
            text: 'Not Connected'
            font_size: sp(40)
            bold: True
            size_hint_y: 0.3
            color: 0.7, 0.2, 0.2, 1

        # ── Detail info ──
        Widget:
            size_hint_y: None
            height: dp(12)
        Label:
            id: detail_label
            text: 'Configure connection below'
            font_size: sp(14)
            size_hint_y: None
            height: dp(48)
            color: app.theme_text_detail
            text_size: self.size
            halign: 'center'
            valign: 'top'

        # ── Preset selector ──
        BoxLayout:
            size_hint_y: None
            height: dp(44)
            spacing: dp(10)
            padding: [dp(40), 0, dp(40), 0]

            Label:
                text: 'Preset:'
                size_hint_x: None
                width: dp(50)
                font_size: sp(14)
                color: app.theme_text_label
            Spinner:
                id: preset_spinner
                text: ''
                values: ['Herelink (UDP out 14552)', 'Herelink (UDP out 14551)', 'Herelink (UDP in 14550)', 'Desktop (UDP in 14550)', 'Custom']
                font_size: sp(14)
                background_color: app.theme_bg_spinner
                color: app.theme_text_primary
                on_text: root.on_preset_changed(self.text)

        # ── Transport config ──
        BoxLayout:
            size_hint_y: None
            height: dp(44)
            spacing: dp(10)
            padding: [dp(40), 0, dp(40), 0]

            Label:
                text: 'Mode:'
                size_hint_x: None
                width: dp(42)
                font_size: sp(14)
                color: app.theme_text_label
            Spinner:
                id: conn_type_spinner
                text: 'udpin'
                values: ['udpin', 'udpout', 'tcp']
                font_size: sp(14)
                size_hint_x: 0.22
                background_color: app.theme_bg_spinner
                color: app.theme_text_primary

            Label:
                text: 'IP:'
                size_hint_x: None
                width: dp(24)
                font_size: sp(14)
                color: app.theme_text_label
            TextInput:
                id: ip_input
                text: '0.0.0.0'
                font_size: sp(14)
                multiline: False
                size_hint_x: 0.38
                input_filter: None
                background_color: app.theme_bg_input
                foreground_color: app.theme_text_primary
                cursor_color: app.theme_text_primary

            Label:
                text: 'Port:'
                size_hint_x: None
                width: dp(36)
                font_size: sp(14)
                color: app.theme_text_label
            TextInput:
                id: port_input
                text: '14550'
                font_size: sp(14)
                multiline: False
                size_hint_x: 0.2
                input_filter: 'int'
                background_color: app.theme_bg_input
                foreground_color: app.theme_text_primary
                cursor_color: app.theme_text_primary

        # ── Connect button ──
        BoxLayout:
            size_hint_y: None
            height: dp(52)
            padding: [dp(60), 0, dp(60), 0]
            spacing: dp(20)

            Button:
                id: connect_btn
                text: 'Connect'
                font_size: sp(18)
                background_color: app.theme_btn_connect
                on_release: root.on_connect_toggle()

        # ── Demo mode toggle ──
        BoxLayout:
            size_hint_y: None
            height: dp(44)
            padding: [dp(60), 0, dp(60), 0]
            spacing: dp(10)

            Label:
                text: 'Demo Mode (simulated telemetry)'
                font_size: sp(14)
                color: app.theme_text_label
                halign: 'right'
                text_size: self.size
                valign: 'middle'

            Switch:
                id: demo_toggle
                size_hint_x: None
                width: dp(80)
                active: False
                on_active: root.on_demo_toggle(self.active)

        Widget:
            size_hint_y: 0.1


# ═══════════════════════════════════════════════════════════════════════════
# Placeholder screens
# ═══════════════════════════════════════════════════════════════════════════
# ═══════════════════════════════════════════════════════════════════════════
# Unified Flight Screen: Telemetry (left) | HUD (top-right) | Commands (bottom-right)
# ═══════════════════════════════════════════════════════════════════════════
<FlightScreen>:
    BoxLayout:
        orientation: 'horizontal'
        spacing: dp(4)
        padding: dp(4)

        # ════════ LEFT HALF: Telemetry (top) + Status Messages (bottom) ════════
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.5
            spacing: dp(4)

            # ──── TOP LEFT: Telemetry Table ────
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: 0.5
                spacing: dp(2)

                # Title bar
                BoxLayout:
                    size_hint_y: None
                    height: dp(22)
                    Label:
                        text: 'Telemetry'
                        font_size: sp(14)
                        bold: True
                        color: app.theme_text_title
                        halign: 'left'
                        text_size: self.size
                        valign: 'middle'
                    Button:
                        text: 'Copy'
                        font_size: sp(10)
                        size_hint_x: None
                        width: dp(50)
                        background_color: app.theme_btn_action
                        color: app.theme_text_copy_btn
                        on_release: root.copy_snapshot()

                # 4-column tile grid
                ScrollView:
                    do_scroll_y: True
                    do_scroll_x: False
                    GridLayout:
                        cols: 4
                        size_hint_y: None
                        height: self.minimum_height
                        spacing: dp(3)
                        padding: dp(2)
                        row_default_height: dp(48)
                        row_force_default: True

                        # Row 1: System + Battery
                        TelemetryTile:
                            id: tile_mode
                            label_text: 'MODE'
                        TelemetryTile:
                            id: tile_armed
                            label_text: 'ARMED'
                        TelemetryTile:
                            id: tile_time
                            label_text: 'TIME'
                        TelemetryTile:
                            id: tile_batt_pct
                            label_text: 'BATT %'

                        # Row 2: Battery + Navigation
                        TelemetryTile:
                            id: tile_voltage
                            label_text: 'VOLTAGE'
                        TelemetryTile:
                            id: tile_current
                            label_text: 'CURRENT'
                        TelemetryTile:
                            id: tile_alt_rel
                            label_text: 'ALT REL'
                        TelemetryTile:
                            id: tile_alt_amsl
                            label_text: 'ALT AMSL'

                        # Row 3: Navigation + Speed
                        TelemetryTile:
                            id: tile_heading
                            label_text: 'HEADING'
                        TelemetryTile:
                            id: tile_gndspd
                            label_text: 'GND SPD'
                        TelemetryTile:
                            id: tile_vertspd
                            label_text: 'VERT SPD'

                        # Row 4: GPS + Radio
                        TelemetryTile:
                            id: tile_gps_fix
                            label_text: 'GPS FIX'
                        TelemetryTile:
                            id: tile_sats
                            label_text: 'SATS'
                        TelemetryTile:
                            id: tile_hdop
                            label_text: 'HDOP'
                        TelemetryTile:
                            id: tile_rssi
                            label_text: 'RSSI'

                        # Row 5: Remaining
                        TelemetryTile:
                            id: tile_throttle
                            label_text: 'THROTTLE'
                        Widget:
                        Widget:
                        Widget:

            # ──── BOTTOM LEFT: Status Messages ────
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: 0.5
                spacing: dp(2)

                Label:
                    text: 'Status Messages'
                    font_size: sp(12)
                    bold: True
                    size_hint_y: None
                    height: dp(20)
                    color: app.theme_text_title
                    halign: 'left'
                    text_size: self.size
                    valign: 'middle'
                    padding: [dp(4), 0]

                ScrollView:
                    do_scroll_y: True
                    do_scroll_x: False
                    canvas.before:
                        Color:
                            rgba: app.theme_bg_status_log
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    Label:
                        id: status_log
                        text: 'No messages'
                        font_size: sp(14)
                        size_hint_y: None
                        height: self.texture_size[1]
                        text_size: self.width, None
                        color: app.theme_text_status_log
                        halign: 'left'
                        valign: 'top'
                        padding: dp(4), dp(2)

        # ════════ RIGHT HALF ════════
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.5
            spacing: dp(4)

            # ──── TOP RIGHT: HUD ────
            FlightHUD:
                id: hud
                size_hint_y: 0.5

            # ──── BOTTOM RIGHT: Commands ────
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: 0.5
                spacing: dp(20)
                padding: dp(4)

                # Armed indicator + mode (compact header)
                BoxLayout:
                    size_hint_y: None
                    height: dp(24)
                    Label:
                        id: armed_indicator
                        text: 'DISARMED'
                        font_size: sp(16)
                        bold: True
                        color: app.theme_text_title
                    Label:
                        id: mode_display
                        text: 'Mode: ---'
                        font_size: sp(12)
                        color: app.theme_text_mode_display

                # Mission generator
                BoxLayout:
                    size_hint_y: None
                    height: dp(34)
                    spacing: dp(4)
                    Label:
                        text: 'Alt (m):'
                        font_size: sp(11)
                        size_hint_x: None
                        width: dp(50)
                        color: app.theme_text_label
                    TextInput:
                        id: vp_altitude
                        text: '120'
                        font_size: sp(12)
                        multiline: False
                        size_hint_x: 0.3
                        input_filter: 'float'
                        background_color: app.theme_bg_input
                        foreground_color: app.theme_text_primary
                        cursor_color: app.theme_text_primary
                    Button:
                        text: 'GENERATE'
                        font_size: sp(11)
                        bold: True
                        size_hint_x: 0.4
                        background_color: app.theme_btn_generate
                        on_release: root.on_generate_mission()

                # PRE-FLIGHT CHECKLIST | ARM & TAKEOFF (swapped positions)
                BoxLayout:
                    size_hint_y: None
                    height: dp(36)
                    spacing: dp(4)
                    Button:
                        id: checklist_btn
                        text: 'PRE-FLIGHT CHECKLIST'
                        font_size: sp(11)
                        bold: True
                        background_color: app.theme_btn_safe
                        on_release: root.on_checklist()
                    Button:
                        id: arm_btn
                        text: 'ARM & TAKEOFF'
                        font_size: sp(11)
                        bold: True
                        disabled: True
                        background_color: app.theme_btn_danger
                        on_release: root.on_arm()

                # LOITER | RTL
                BoxLayout:
                    size_hint_y: None
                    height: dp(34)
                    spacing: dp(4)
                    Button:
                        text: 'LOITER'
                        font_size: sp(12)
                        background_color: app.theme_btn_action
                        on_release: root.on_loiter()
                    Button:
                        text: 'RTL'
                        font_size: sp(12)
                        background_color: app.theme_btn_warning
                        on_release: root.on_rtl()

                # Feedback (fills remaining space)
                Label:
                    id: cmd_feedback
                    text: ''
                    font_size: sp(10)
                    color: app.theme_text_cmd_feedback
                    halign: 'center'
                    text_size: self.size
                    valign: 'top'

<SensorPlotScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(6)
        spacing: dp(4)

        # Temperature plot
        TimeSeriesPlot:
            id: temp_plot
            title: 'Temperature (\u00b0C)'
            y_label: '\u00b0C'
            x_window: 30

        # Humidity plot
        TimeSeriesPlot:
            id: rh_plot
            title: 'Relative Humidity (%)'
            y_label: '%'
            x_window: 30

        # Controls bar
        BoxLayout:
            size_hint_y: None
            height: dp(36)
            spacing: dp(8)
            padding: [dp(20), 0, dp(20), 0]

            Button:
                id: pause_btn
                text: 'Pause'
                font_size: sp(13)
                size_hint_x: 0.25
                background_color: app.theme_btn_action
                on_release: root.toggle_pause()

            Button:
                text: 'Clear'
                font_size: sp(13)
                size_hint_x: 0.25
                background_color: app.theme_btn_warning
                on_release: root.clear_plots()

            Button:
                text: 'Export CSV'
                font_size: sp(13)
                size_hint_x: 0.25
                background_color: app.theme_btn_action
                on_release: root.export_csv()

            Label:
                id: export_feedback
                text: ''
                font_size: sp(11)
                size_hint_x: 0.25
                color: app.theme_text_feedback
                halign: 'left'
                text_size: self.size
                valign: 'middle'

<ProfileScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(6)
        spacing: dp(4)

        BoxLayout:
            orientation: 'horizontal'
            spacing: dp(4)

            # Temperature & Dew Point vs Altitude (left)
            ProfilePlot:
                id: temp_profile
                title: 'Temp / Dew Point vs Altitude'
                x_label: '\u00b0C'

            # Wind Speed vs Altitude (right)
            ProfilePlot:
                id: wind_profile
                title: 'Wind Speed vs Altitude'
                x_label: 'm/s'

        # Controls
        BoxLayout:
            size_hint_y: None
            height: dp(36)
            padding: [dp(60), 0, dp(60), 0]
            Button:
                text: 'Clear Profile'
                font_size: sp(13)
                background_color: app.theme_btn_clear
                on_release: root.clear_profile()

<MapScreen>:
    BoxLayout:
        orientation: 'vertical'

        MapWidget:
            id: map_view

        # Controls bar
        BoxLayout:
            size_hint_y: None
            height: dp(36)
            spacing: dp(6)
            padding: [dp(8), 0, dp(8), 0]

            Button:
                text: 'Zoom +'
                font_size: sp(13)
                size_hint_x: 0.15
                background_color: app.theme_bg_input
                on_release: map_view.zoom_in()

            Button:
                text: 'Zoom -'
                font_size: sp(13)
                size_hint_x: 0.15
                background_color: app.theme_bg_input
                on_release: map_view.zoom_out()

            Button:
                text: 'Center'
                font_size: sp(13)
                size_hint_x: 0.18
                background_color: app.theme_btn_map
                on_release: map_view.toggle_center()

            Button:
                text: 'Track'
                font_size: sp(13)
                size_hint_x: 0.18
                background_color: app.theme_btn_map
                on_release: map_view.toggle_track()

            Button:
                text: 'ADS-B'
                font_size: sp(13)
                size_hint_x: 0.18
                background_color: app.theme_btn_map
                on_release: map_view.toggle_adsb()

<ThresholdRow@BoxLayout>:
    size_hint_y: None
    height: dp(36)
    spacing: dp(6)
    label_text: ''
    Label:
        text: root.label_text
        font_size: sp(12)
        color: app.theme_text_settings
        halign: 'right'
        text_size: self.size
        valign: 'middle'
        size_hint_x: 0.6

<SettingsScreen>:
    TabbedPanel:
        do_default_tab: False
        tab_width: self.width / 3
        tab_height: dp(36)

        # ══════════════════════════════════════════════════════════
        # Tab 1: Alert Thresholds
        # ══════════════════════════════════════════════════════════
        TabbedPanelItem:
            text: 'Alert Thresholds'
            ScrollView:
                do_scroll_y: True
                do_scroll_x: False
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    padding: [dp(30), dp(10), dp(30), dp(10)]
                    spacing: dp(4)

                    # ── Battery ──
                    SectionLabel:
                        text: 'BATTERY'
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Warning (%)'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_batt_warn
                            text: '50'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Critical (%)'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_batt_crit
                            text: '30'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Min Voltage (V)'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_volt_min
                            text: '22.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary

                    # ── GPS ──
                    SectionLabel:
                        text: 'GPS'
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Min Satellites'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_gps_sats
                            text: '6'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Max HDOP'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_hdop_max
                            text: '3.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary

                    # ── Radio ──
                    SectionLabel:
                        text: 'RADIO'
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Min RSSI (%)'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_rssi_min
                            text: '40'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary

                    # ── Environment ──
                    SectionLabel:
                        text: 'ENVIRONMENT'
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Max Wind (m/s)'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_wind_max
                            text: '15.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Min Temp (\u00b0C)'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_temp_min
                            text: '-10.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Max Temp (\u00b0C)'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_temp_max
                            text: '50.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Min RH (%)'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_rh_min
                            text: '10.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        Label:
                            text: 'Max RH (%)'
                            font_size: sp(12)
                            color: app.theme_text_settings
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_rh_max
                            text: '95.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: app.theme_bg_input
                            foreground_color: app.theme_text_primary
                            cursor_color: app.theme_text_primary

                    # ── Buttons ──
                    BoxLayout:
                        size_hint_y: None
                        height: dp(44)
                        spacing: dp(10)
                        padding: [dp(10), dp(4), dp(10), dp(4)]
                        Button:
                            text: 'Apply'
                            font_size: sp(14)
                            background_color: app.theme_btn_apply
                            on_release: root.apply_thresholds()
                        Button:
                            text: 'Reset Defaults'
                            font_size: sp(14)
                            background_color: app.theme_btn_clear
                            on_release: root.reset_defaults()

                    Label:
                        id: settings_feedback
                        text: ''
                        font_size: sp(12)
                        size_hint_y: None
                        height: dp(24)
                        color: app.theme_text_feedback
                        halign: 'center'
                        text_size: self.size
                        valign: 'middle'

                    Widget:
                        size_hint_y: None
                        height: dp(10)

        # ══════════════════════════════════════════════════════════
        # Tab 2: Wind Coefficients
        # ══════════════════════════════════════════════════════════
        TabbedPanelItem:
            text: 'Wind Coefficients'
            BoxLayout:
                orientation: 'vertical'
                padding: [dp(30), dp(10), dp(30), dp(10)]
                spacing: dp(6)

                Label:
                    text: 'Quadratic Wind Estimation'
                    font_size: sp(16)
                    bold: True
                    size_hint_y: None
                    height: dp(28)
                    color: app.theme_text_title

                Label:
                    text: 'wind = max(0, A * tan(|pitch|) + B * sqrt(tan(|pitch|)))'
                    font_size: sp(11)
                    size_hint_y: None
                    height: dp(20)
                    color: app.theme_text_formula
                    halign: 'center'
                    text_size: self.size

                SectionLabel:
                    text: 'COEFFICIENTS'

                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    spacing: dp(6)
                    Label:
                        text: 'wsA (tan term)'
                        font_size: sp(13)
                        color: app.theme_text_settings
                        halign: 'right'
                        text_size: self.size
                        valign: 'middle'
                        size_hint_x: 0.6
                    TextInput:
                        id: wind_ws_a
                        text: '37.1'
                        font_size: sp(14)
                        multiline: False
                        size_hint_x: 0.4
                        input_filter: 'float'
                        background_color: app.theme_bg_input
                        foreground_color: app.theme_text_primary
                        cursor_color: app.theme_text_primary

                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    spacing: dp(6)
                    Label:
                        text: 'wsB (sqrt term)'
                        font_size: sp(13)
                        color: app.theme_text_settings
                        halign: 'right'
                        text_size: self.size
                        valign: 'middle'
                        size_hint_x: 0.6
                    TextInput:
                        id: wind_ws_b
                        text: '3.8'
                        font_size: sp(14)
                        multiline: False
                        size_hint_x: 0.4
                        input_filter: 'float'
                        background_color: app.theme_bg_input
                        foreground_color: app.theme_text_primary
                        cursor_color: app.theme_text_primary

                # ── Buttons ──
                BoxLayout:
                    size_hint_y: None
                    height: dp(44)
                    spacing: dp(10)
                    padding: [dp(10), dp(4), dp(10), dp(4)]
                    Button:
                        text: 'Apply'
                        font_size: sp(14)
                        background_color: app.theme_btn_apply
                        on_release: root.apply_wind_coeffs()
                    Button:
                        text: 'Reset Defaults'
                        font_size: sp(14)
                        background_color: app.theme_btn_clear
                        on_release: root.reset_wind_defaults()

                Label:
                    id: wind_feedback
                    text: ''
                    font_size: sp(12)
                    size_hint_y: None
                    height: dp(24)
                    color: app.theme_text_feedback
                    halign: 'center'
                    text_size: self.size
                    valign: 'middle'

                Widget:

        # ══════════════════════════════════════════════════════════
        # Tab 3: App Settings
        # ══════════════════════════════════════════════════════════
        TabbedPanelItem:
            text: 'App Settings'
            BoxLayout:
                orientation: 'vertical'
                padding: [dp(30), dp(10), dp(30), dp(10)]
                spacing: dp(6)

                Label:
                    text: 'App Settings'
                    font_size: sp(16)
                    bold: True
                    size_hint_y: None
                    height: dp(28)
                    color: app.theme_text_title

                SectionLabel:
                    text: 'THEME'

                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    spacing: dp(6)
                    Label:
                        text: 'Color Theme'
                        font_size: sp(13)
                        color: app.theme_text_settings
                        halign: 'right'
                        text_size: self.size
                        valign: 'middle'
                        size_hint_x: 0.6
                    Spinner:
                        id: theme_spinner
                        text: 'Dark'
                        values: ['Dark', 'High Contrast']
                        font_size: sp(13)
                        size_hint_x: 0.4
                        background_color: app.theme_bg_spinner
                        color: app.theme_text_primary
                        on_text: root.on_theme_changed(self.text)

                Label:
                    text: 'High Contrast improves visibility for outdoor use in bright sunlight.'
                    font_size: sp(11)
                    size_hint_y: None
                    height: dp(20)
                    color: app.theme_text_settings
                    halign: 'center'
                    text_size: self.size

                Label:
                    id: theme_feedback
                    text: ''
                    font_size: sp(12)
                    size_hint_y: None
                    height: dp(24)
                    color: app.theme_text_feedback
                    halign: 'center'
                    text_size: self.size
                    valign: 'middle'

                Widget:
