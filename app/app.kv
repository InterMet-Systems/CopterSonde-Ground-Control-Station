#:kivy 2.0

# ═══════════════════════════════════════════════════════════════════════════
# Root widget: vertical BoxLayout with ScreenManager + bottom nav bar
# ═══════════════════════════════════════════════════════════════════════════
<GCSRoot>:
    orientation: 'vertical'
    canvas.before:
        Color:
            rgba: 0.12, 0.12, 0.14, 1
        Rectangle:
            pos: self.pos
            size: self.size

    # ── Screen area ──
    ScreenManager:
        id: sm

    # ── Bottom navigation bar ──
    BoxLayout:
        size_hint_y: None
        height: dp(48)
        canvas.before:
            Color:
                rgba: 0.15, 0.15, 0.18, 1
            Rectangle:
                pos: self.pos
                size: self.size

        NavButton:
            text: 'Connect'
            on_release: app.switch_screen('connection')
        NavButton:
            text: 'Command'
            on_release: app.switch_screen('command')
        NavButton:
            text: 'Map'
            on_release: app.switch_screen('map')
        NavButton:
            text: 'HUD'
            on_release: app.switch_screen('hud')
        NavButton:
            text: 'Telemetry'
            on_release: app.switch_screen('telemetry')
        NavButton:
            text: 'Sensors'
            on_release: app.switch_screen('sensor_plots')
        NavButton:
            text: 'Profiles'
            on_release: app.switch_screen('profile')
        NavButton:
            text: 'Settings'
            on_release: app.switch_screen('settings')


# ═══════════════════════════════════════════════════════════════════════════
# Reusable nav button
# ═══════════════════════════════════════════════════════════════════════════
<NavButton@Button>:
    font_size: sp(12)
    size_hint_x: 1
    background_color: 0.2, 0.2, 0.25, 1
    color: 0.8, 0.85, 0.9, 1


# ═══════════════════════════════════════════════════════════════════════════
# Reusable telemetry tile and section label
# ═══════════════════════════════════════════════════════════════════════════
<TelemetryTile>:
    orientation: 'vertical'
    padding: dp(4)
    canvas.before:
        Color:
            rgba: self.tile_color
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(5)]
    Label:
        text: root.label_text
        font_size: sp(10)
        size_hint_y: 0.35
        color: 0.55, 0.6, 0.65, 1
        halign: 'center'
        text_size: self.size
        valign: 'middle'
    Label:
        text: root.value_text
        font_size: sp(18)
        bold: True
        size_hint_y: 0.65
        color: 1, 1, 1, 1
        halign: 'center'
        text_size: self.size
        valign: 'middle'

<SectionLabel@Label>:
    font_size: sp(10)
    size_hint_y: None
    height: dp(16)
    color: 0.45, 0.48, 0.52, 1
    halign: 'left'
    text_size: self.size
    valign: 'middle'
    bold: True


# ═══════════════════════════════════════════════════════════════════════════
# Connection Screen
# ═══════════════════════════════════════════════════════════════════════════
<ConnectionScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(12)

        # ── Title ──
        Label:
            text: 'CopterSonde GCS'
            font_size: sp(22)
            bold: True
            size_hint_y: None
            height: dp(36)
            color: 0.8, 0.85, 0.9, 1

        # ── Status indicator ──
        Label:
            id: status_label
            text: 'Not Connected'
            font_size: sp(40)
            bold: True
            size_hint_y: 0.3
            color: 0.7, 0.2, 0.2, 1

        # ── Detail info ──
        Label:
            id: detail_label
            text: 'Configure connection below'
            font_size: sp(14)
            size_hint_y: None
            height: dp(48)
            color: 0.6, 0.6, 0.6, 1
            text_size: self.size
            halign: 'center'
            valign: 'top'

        # ── Transport config ──
        BoxLayout:
            size_hint_y: None
            height: dp(44)
            spacing: dp(10)
            padding: [dp(40), 0, dp(40), 0]

            Label:
                text: 'Mode:'
                size_hint_x: None
                width: dp(42)
                font_size: sp(14)
                color: 0.7, 0.7, 0.7, 1
            Spinner:
                id: conn_type_spinner
                text: 'udpin'
                values: ['udpin', 'udpout']
                font_size: sp(14)
                size_hint_x: 0.22
                background_color: 0.25, 0.25, 0.3, 1
                color: 1, 1, 1, 1

            Label:
                text: 'IP:'
                size_hint_x: None
                width: dp(24)
                font_size: sp(14)
                color: 0.7, 0.7, 0.7, 1
            TextInput:
                id: ip_input
                text: '0.0.0.0'
                font_size: sp(14)
                multiline: False
                size_hint_x: 0.38
                input_filter: None
                background_color: 0.2, 0.2, 0.25, 1
                foreground_color: 1, 1, 1, 1
                cursor_color: 1, 1, 1, 1

            Label:
                text: 'Port:'
                size_hint_x: None
                width: dp(36)
                font_size: sp(14)
                color: 0.7, 0.7, 0.7, 1
            TextInput:
                id: port_input
                text: '14550'
                font_size: sp(14)
                multiline: False
                size_hint_x: 0.2
                input_filter: 'int'
                background_color: 0.2, 0.2, 0.25, 1
                foreground_color: 1, 1, 1, 1
                cursor_color: 1, 1, 1, 1

        # ── Connect button ──
        BoxLayout:
            size_hint_y: None
            height: dp(52)
            padding: [dp(60), 0, dp(60), 0]
            spacing: dp(20)

            Button:
                id: connect_btn
                text: 'Connect'
                font_size: sp(18)
                background_color: 0.2, 0.55, 0.3, 1
                on_release: root.on_connect_toggle()

        # ── Demo mode toggle ──
        BoxLayout:
            size_hint_y: None
            height: dp(44)
            padding: [dp(60), 0, dp(60), 0]
            spacing: dp(10)

            Label:
                text: 'Demo Mode (simulated telemetry)'
                font_size: sp(14)
                color: 0.7, 0.7, 0.7, 1
                halign: 'right'
                text_size: self.size
                valign: 'middle'

            Switch:
                id: demo_toggle
                size_hint_x: None
                width: dp(80)
                active: False
                on_active: root.on_demo_toggle(self.active)

        Widget:
            size_hint_y: 0.1


# ═══════════════════════════════════════════════════════════════════════════
# Placeholder screens
# ═══════════════════════════════════════════════════════════════════════════
<TelemetryScreen>:
    ScrollView:
        do_scroll_y: True
        do_scroll_x: False
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            padding: dp(10)
            spacing: dp(4)

            # ── Title bar ──
            BoxLayout:
                size_hint_y: None
                height: dp(28)
                Label:
                    text: 'Telemetry'
                    font_size: sp(20)
                    bold: True
                    color: 0.8, 0.85, 0.9, 1
                    halign: 'left'
                    text_size: self.size
                    valign: 'middle'
                Label:
                    id: last_update_label
                    text: ''
                    font_size: sp(11)
                    color: 0.5, 0.5, 0.5, 1
                    halign: 'right'
                    text_size: self.size
                    valign: 'middle'

            # ── System ──
            SectionLabel:
                text: 'SYSTEM'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_mode
                    label_text: 'FLIGHT MODE'
                TelemetryTile:
                    id: tile_armed
                    label_text: 'ARMED'
                TelemetryTile:
                    id: tile_time
                    label_text: 'TIME IN AIR'

            # ── Battery ──
            SectionLabel:
                text: 'BATTERY'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_batt_pct
                    label_text: 'BATTERY %'
                TelemetryTile:
                    id: tile_voltage
                    label_text: 'VOLTAGE'
                TelemetryTile:
                    id: tile_current
                    label_text: 'CURRENT'

            # ── Navigation ──
            SectionLabel:
                text: 'NAVIGATION'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_alt_rel
                    label_text: 'ALT REL'
                TelemetryTile:
                    id: tile_alt_amsl
                    label_text: 'ALT AMSL'
                TelemetryTile:
                    id: tile_heading
                    label_text: 'HEADING'

            # ── Speed ──
            SectionLabel:
                text: 'SPEED'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_gndspd
                    label_text: 'GND SPEED'
                TelemetryTile:
                    id: tile_airspd
                    label_text: 'AIR SPEED'
                TelemetryTile:
                    id: tile_vertspd
                    label_text: 'VERT SPEED'

            # ── GPS ──
            SectionLabel:
                text: 'GPS'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_gps_fix
                    label_text: 'FIX TYPE'
                TelemetryTile:
                    id: tile_sats
                    label_text: 'SATELLITES'
                TelemetryTile:
                    id: tile_hdop
                    label_text: 'HDOP'

            # ── Radio / Throttle ──
            SectionLabel:
                text: 'RADIO / THROTTLE'
            GridLayout:
                cols: 3
                size_hint_y: None
                height: dp(58)
                spacing: dp(5)
                TelemetryTile:
                    id: tile_rssi
                    label_text: 'RSSI'
                TelemetryTile:
                    id: tile_throttle
                    label_text: 'THROTTLE'
                Widget:

            # ── Copy snapshot ──
            BoxLayout:
                size_hint_y: None
                height: dp(38)
                padding: [dp(80), dp(2), dp(80), dp(2)]
                Button:
                    text: 'Copy Snapshot'
                    font_size: sp(13)
                    background_color: 0.25, 0.35, 0.5, 1
                    color: 0.85, 0.9, 0.95, 1
                    on_release: root.copy_snapshot()

<CommandScreen>:
    BoxLayout:
        orientation: 'horizontal'
        padding: dp(6)
        spacing: dp(6)

        # ════════ Left half: Status messages ════════
        BoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.5
            spacing: dp(4)

            SectionLabel:
                text: 'STATUS MESSAGES'
            ScrollView:
                do_scroll_y: True
                do_scroll_x: False
                canvas.before:
                    Color:
                        rgba: 0.08, 0.08, 0.1, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Label:
                    id: status_log
                    text: 'No messages'
                    font_size: sp(15)
                    size_hint_y: None
                    height: self.texture_size[1]
                    text_size: self.width, None
                    color: 0.6, 0.7, 0.65, 1
                    halign: 'left'
                    valign: 'top'
                    padding: dp(8), dp(4)

        # ════════ Right half: Commands ════════
        ScrollView:
            size_hint_x: 0.5
            do_scroll_y: True
            do_scroll_x: False
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(6)

                # ── Armed status indicator ──
                Label:
                    id: armed_indicator
                    text: 'DISARMED'
                    font_size: sp(26)
                    bold: True
                    size_hint_y: None
                    height: dp(34)
                    color: 0.3, 0.8, 0.4, 1

                Label:
                    id: mode_display
                    text: 'Mode: ---'
                    font_size: sp(14)
                    size_hint_y: None
                    height: dp(20)
                    color: 0.6, 0.65, 0.7, 1

                # ── Vertical Profile Mission Generator ──
                SectionLabel:
                    text: 'VERTICAL PROFILE MISSION'
                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    spacing: dp(6)
                    padding: [dp(6), 0, dp(6), 0]
                    Label:
                        text: 'Target Alt (m):'
                        font_size: sp(13)
                        size_hint_x: None
                        width: dp(90)
                        color: 0.7, 0.7, 0.7, 1
                    TextInput:
                        id: vp_altitude
                        text: '120'
                        font_size: sp(13)
                        multiline: False
                        size_hint_x: 0.25
                        input_filter: 'float'
                        background_color: 0.2, 0.2, 0.25, 1
                        foreground_color: 1, 1, 1, 1
                        cursor_color: 1, 1, 1, 1
                    Button:
                        text: 'GENERATE'
                        font_size: sp(13)
                        bold: True
                        size_hint_x: 0.4
                        background_color: 0.25, 0.45, 0.55, 1
                        on_release: root.on_generate_mission()

                # ── Arm & Takeoff / Disarm ──
                SectionLabel:
                    text: 'ARM & TAKEOFF'
                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    spacing: dp(6)
                    padding: [dp(6), 0, dp(6), 0]
                    Button:
                        text: 'ARM & TAKEOFF'
                        font_size: sp(14)
                        bold: True
                        background_color: 0.7, 0.3, 0.15, 1
                        on_release: root.on_arm()
                    Button:
                        text: 'DISARM'
                        font_size: sp(14)
                        bold: True
                        background_color: 0.2, 0.45, 0.25, 1
                        on_release: root.on_disarm()

                # ── Flight Mode ──
                SectionLabel:
                    text: 'FLIGHT MODE'
                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    spacing: dp(6)
                    padding: [dp(6), 0, dp(6), 0]
                    Spinner:
                        id: mode_spinner
                        text: 'STABILIZE'
                        values: ['STABILIZE', 'ALT_HOLD', 'LOITER', 'GUIDED', 'AUTO', 'RTL', 'LAND', 'CIRCLE', 'POSHOLD', 'BRAKE']
                        font_size: sp(13)
                        size_hint_x: 0.6
                        background_color: 0.25, 0.25, 0.3, 1
                        color: 1, 1, 1, 1
                    Button:
                        text: 'SET MODE'
                        font_size: sp(13)
                        size_hint_x: 0.4
                        background_color: 0.25, 0.35, 0.5, 1
                        on_release: root.on_set_mode()

                # ── Flight Commands ──
                SectionLabel:
                    text: 'FLIGHT COMMANDS'
                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    spacing: dp(6)
                    padding: [dp(6), 0, dp(6), 0]
                    Button:
                        text: 'LAND'
                        font_size: sp(14)
                        background_color: 0.25, 0.35, 0.5, 1
                        on_release: root.on_land()
                    Button:
                        text: 'RTL'
                        font_size: sp(14)
                        background_color: 0.55, 0.35, 0.1, 1
                        on_release: root.on_rtl()

                # ── Feedback ──
                Label:
                    id: cmd_feedback
                    text: ''
                    font_size: sp(12)
                    size_hint_y: None
                    height: dp(24)
                    color: 0.5, 0.6, 0.7, 1
                    halign: 'center'
                    text_size: self.size
                    valign: 'middle'

<HUDScreen>:
    FlightHUD:
        id: hud

<SensorPlotScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(6)
        spacing: dp(4)

        # Temperature plot
        TimeSeriesPlot:
            id: temp_plot
            title: 'Temperature (\u00b0C)'
            y_label: '\u00b0C'
            x_window: 120

        # Humidity plot
        TimeSeriesPlot:
            id: rh_plot
            title: 'Relative Humidity (%)'
            y_label: '%'
            x_window: 120

        # Controls bar
        BoxLayout:
            size_hint_y: None
            height: dp(36)
            spacing: dp(8)
            padding: [dp(20), 0, dp(20), 0]

            Button:
                id: pause_btn
                text: 'Pause'
                font_size: sp(13)
                size_hint_x: 0.3
                background_color: 0.25, 0.35, 0.5, 1
                on_release: root.toggle_pause()

            Button:
                text: 'Export CSV'
                font_size: sp(13)
                size_hint_x: 0.3
                background_color: 0.25, 0.35, 0.5, 1
                on_release: root.export_csv()

            Label:
                id: export_feedback
                text: ''
                font_size: sp(11)
                size_hint_x: 0.4
                color: 0.5, 0.6, 0.5, 1
                halign: 'left'
                text_size: self.size
                valign: 'middle'

<ProfileScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(6)
        spacing: dp(4)

        BoxLayout:
            orientation: 'horizontal'
            spacing: dp(4)

            # Temperature & Dew Point vs Altitude (left)
            ProfilePlot:
                id: temp_profile
                title: 'Temp / Dew Point vs Altitude'
                x_label: '\u00b0C'

            # Wind Speed vs Altitude (right)
            ProfilePlot:
                id: wind_profile
                title: 'Wind Speed vs Altitude'
                x_label: 'm/s'

        # Controls
        BoxLayout:
            size_hint_y: None
            height: dp(36)
            padding: [dp(60), 0, dp(60), 0]
            Button:
                text: 'Clear Profile'
                font_size: sp(13)
                background_color: 0.5, 0.25, 0.2, 1
                on_release: root.clear_profile()

<MapScreen>:
    BoxLayout:
        orientation: 'vertical'

        MapWidget:
            id: map_view

        # Controls bar
        BoxLayout:
            size_hint_y: None
            height: dp(36)
            spacing: dp(6)
            padding: [dp(8), 0, dp(8), 0]

            Button:
                text: 'Zoom +'
                font_size: sp(13)
                size_hint_x: 0.15
                background_color: 0.2, 0.2, 0.25, 1
                on_release: map_view.zoom_in()

            Button:
                text: 'Zoom -'
                font_size: sp(13)
                size_hint_x: 0.15
                background_color: 0.2, 0.2, 0.25, 1
                on_release: map_view.zoom_out()

            Button:
                text: 'Center'
                font_size: sp(13)
                size_hint_x: 0.18
                background_color: 0.2, 0.3, 0.4, 1
                on_release: map_view.toggle_center()

            Button:
                text: 'Track'
                font_size: sp(13)
                size_hint_x: 0.18
                background_color: 0.2, 0.3, 0.4, 1
                on_release: map_view.toggle_track()

            Button:
                text: 'ADS-B'
                font_size: sp(13)
                size_hint_x: 0.18
                background_color: 0.2, 0.3, 0.4, 1
                on_release: map_view.toggle_adsb()

<ThresholdRow@BoxLayout>:
    size_hint_y: None
    height: dp(36)
    spacing: dp(6)
    label_text: ''
    Label:
        text: root.label_text
        font_size: sp(12)
        color: 0.65, 0.65, 0.7, 1
        halign: 'right'
        text_size: self.size
        valign: 'middle'
        size_hint_x: 0.6

<SettingsScreen>:
    TabbedPanel:
        do_default_tab: False
        tab_width: self.width / 2
        tab_height: dp(36)

        # ══════════════════════════════════════════════════════════
        # Tab 1: Alert Thresholds
        # ══════════════════════════════════════════════════════════
        TabbedPanelItem:
            text: 'Alert Thresholds'
            ScrollView:
                do_scroll_y: True
                do_scroll_x: False
                BoxLayout:
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    padding: dp(10)
                    spacing: dp(4)

                    # ── Battery ──
                    SectionLabel:
                        text: 'BATTERY'
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Warning (%)'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_batt_warn
                            text: '50'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Critical (%)'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_batt_crit
                            text: '30'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Min Voltage (V)'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_volt_min
                            text: '22.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1

                    # ── GPS ──
                    SectionLabel:
                        text: 'GPS'
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Min Satellites'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_gps_sats
                            text: '6'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Max HDOP'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_hdop_max
                            text: '3.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1

                    # ── Radio ──
                    SectionLabel:
                        text: 'RADIO'
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Min RSSI (%)'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_rssi_min
                            text: '40'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1

                    # ── Environment ──
                    SectionLabel:
                        text: 'ENVIRONMENT'
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Max Wind (m/s)'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_wind_max
                            text: '15.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Min Temp (\u00b0C)'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_temp_min
                            text: '-10.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Max Temp (\u00b0C)'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_temp_max
                            text: '50.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Min RH (%)'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_rh_min
                            text: '10.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1
                    BoxLayout:
                        size_hint_y: None
                        height: dp(36)
                        spacing: dp(6)
                        padding: [dp(20), 0, dp(20), 0]
                        Label:
                            text: 'Max RH (%)'
                            font_size: sp(12)
                            color: 0.65, 0.65, 0.7, 1
                            halign: 'right'
                            text_size: self.size
                            valign: 'middle'
                            size_hint_x: 0.6
                        TextInput:
                            id: th_rh_max
                            text: '95.0'
                            font_size: sp(13)
                            multiline: False
                            size_hint_x: 0.4
                            input_filter: 'float'
                            background_color: 0.2, 0.2, 0.25, 1
                            foreground_color: 1, 1, 1, 1
                            cursor_color: 1, 1, 1, 1

                    # ── Buttons ──
                    BoxLayout:
                        size_hint_y: None
                        height: dp(44)
                        spacing: dp(10)
                        padding: [dp(40), dp(4), dp(40), dp(4)]
                        Button:
                            text: 'Apply'
                            font_size: sp(14)
                            background_color: 0.2, 0.5, 0.3, 1
                            on_release: root.apply_thresholds()
                        Button:
                            text: 'Reset Defaults'
                            font_size: sp(14)
                            background_color: 0.5, 0.25, 0.2, 1
                            on_release: root.reset_defaults()

                    Label:
                        id: settings_feedback
                        text: ''
                        font_size: sp(12)
                        size_hint_y: None
                        height: dp(24)
                        color: 0.5, 0.7, 0.5, 1
                        halign: 'center'
                        text_size: self.size
                        valign: 'middle'

                    Widget:
                        size_hint_y: None
                        height: dp(10)

        # ══════════════════════════════════════════════════════════
        # Tab 2: Wind Coefficients
        # ══════════════════════════════════════════════════════════
        TabbedPanelItem:
            text: 'Wind Coefficients'
            BoxLayout:
                orientation: 'vertical'
                padding: dp(10)
                spacing: dp(6)

                Label:
                    text: 'Quadratic Wind Estimation'
                    font_size: sp(16)
                    bold: True
                    size_hint_y: None
                    height: dp(28)
                    color: 0.8, 0.85, 0.9, 1

                Label:
                    text: 'wind = max(0, A * tan(|pitch|) + B * sqrt(tan(|pitch|)))'
                    font_size: sp(11)
                    size_hint_y: None
                    height: dp(20)
                    color: 0.5, 0.55, 0.6, 1
                    halign: 'center'
                    text_size: self.size

                SectionLabel:
                    text: 'COEFFICIENTS'

                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    spacing: dp(6)
                    padding: [dp(20), 0, dp(20), 0]
                    Label:
                        text: 'wsA (tan term)'
                        font_size: sp(13)
                        color: 0.65, 0.65, 0.7, 1
                        halign: 'right'
                        text_size: self.size
                        valign: 'middle'
                        size_hint_x: 0.6
                    TextInput:
                        id: wind_ws_a
                        text: '37.1'
                        font_size: sp(14)
                        multiline: False
                        size_hint_x: 0.4
                        input_filter: 'float'
                        background_color: 0.2, 0.2, 0.25, 1
                        foreground_color: 1, 1, 1, 1
                        cursor_color: 1, 1, 1, 1

                BoxLayout:
                    size_hint_y: None
                    height: dp(40)
                    spacing: dp(6)
                    padding: [dp(20), 0, dp(20), 0]
                    Label:
                        text: 'wsB (sqrt term)'
                        font_size: sp(13)
                        color: 0.65, 0.65, 0.7, 1
                        halign: 'right'
                        text_size: self.size
                        valign: 'middle'
                        size_hint_x: 0.6
                    TextInput:
                        id: wind_ws_b
                        text: '3.8'
                        font_size: sp(14)
                        multiline: False
                        size_hint_x: 0.4
                        input_filter: 'float'
                        background_color: 0.2, 0.2, 0.25, 1
                        foreground_color: 1, 1, 1, 1
                        cursor_color: 1, 1, 1, 1

                # ── Buttons ──
                BoxLayout:
                    size_hint_y: None
                    height: dp(44)
                    spacing: dp(10)
                    padding: [dp(40), dp(4), dp(40), dp(4)]
                    Button:
                        text: 'Apply'
                        font_size: sp(14)
                        background_color: 0.2, 0.5, 0.3, 1
                        on_release: root.apply_wind_coeffs()
                    Button:
                        text: 'Reset Defaults'
                        font_size: sp(14)
                        background_color: 0.5, 0.25, 0.2, 1
                        on_release: root.reset_wind_defaults()

                Label:
                    id: wind_feedback
                    text: ''
                    font_size: sp(12)
                    size_hint_y: None
                    height: dp(24)
                    color: 0.5, 0.7, 0.5, 1
                    halign: 'center'
                    text_size: self.size
                    valign: 'middle'

                Widget:
